pico-8 cartridge // http://www.pico-8.com
version 21
__lua__
-- figure out the dimensions
-- of the sprite. bottom-left
-- is constant, so we have h
-- and w.
function analyze(s)
 local px=8*flr(s%16)
 local py=8*flr(s/16)

 local width=0
 local height=0
 
 for y=0,7 do
  for x=0,7 do
   local clr=sget(px+x,py+y)
   if clr~=0 then
    width=max(x+1,width)
    height=max(height,8-y)
   end
  end
 end
 
 return {w=width,h=height}
end

function compress(s,w,h)
 -- we can rle encode, i guess
 -- if we have w and h.
 local px=8*flr(s%16)
 local py=8*flr(s/16)
 
 local runs={}
 local run_len=0
 local current=7
 
 for y=8-h,7 do
  for x=0,(w-1) do
   local clr=sget(px+x,py+y)
   if clr==current then
    run_len+=1
   else 
    while run_len>8 do
     add(runs,8)
     add(runs,0)
     run_len-=8
    end
    add(runs,run_len)
    run_len=1
    current=clr
   end
  end
 end
 
 if current~=0 then
  add(runs,run_len)
 end
 
 return runs 
end

function encode(w,h,runs)
 -- high 4 bits: w
 --  low 4 bits: h
 local bytes={}
 add(bytes,w<<4|h)
 add(bytes,#runs)
   
 -- 3 bits/run,8 runs in 24bit
 -- value.
 --
 --    2         1  
 -- 321098765432109876543210
 -- aaabbbcccdddeeefffggghhh
 -- xxxxxxxxyyyyyyyyzzzzzzzz
 --
 -- to keep life easy we just 
 -- pad out with zeros since 
 -- they affect nothing.
 --
 local i=1
 while i+7<=#runs do
  local acc,j=0
  for j=0,7 do
   acc=(acc<<3)|(runs[i+j]>>16)
  end
  for j=1,3 do
   add(bytes, acc&0x00ff)
   acc=acc<<8
  end
 end
 
 
 
 return c-ofs
end

-- stats, for tuning.
max_glyph_runs=0
max_run_length=0
zero_starts=0

ofs=0x4300
for i=1,66 do
 r=analyze(i)
 print(i..": "..r.w.."x"..r.h)
 runs=compress(i, r.w, r.h)
 
 -- keep track: zero starts are
 -- wasteful so we want to 
 -- minimize them.
 if runs[1]==0 then
  zero_starts+=1
 end
 
 max_glyph_runs=max(
  #runs,
  max_glyph_runs)
 
 rl=""
 for run_i=1,#runs do
  max_run_length=max(
   runs[run_i],
   max_run_length)
  rl=rl.." "..runs[run_i]
  if #rl>30 then
   print(rl)
   rl=""
  end
 end
 if #rl>0 then
  print(rl)
 end
 
 --byte_len=encode(ofs,r.w,r.h,w)
 --print("  "..ofs.." "..byte_len)
 --ofs += byte_len
 
 if i%5==0 then
  repeat
  until btn(üÖæÔ∏è)
 end
end

print ""
print("max glyph runs: "..max_glyph_runs)
print("max run length: "..max_run_length)
print("   zero starts: "..zero_starts.."/66")
__gfx__
00000000077000007700000007700000777000007777000077770000077000007007000070000000000700007007000070000000770770007007000007700000
00000000700700007070000070070000700700007000000070000000700700007007000070000000000700007007000070000000707070007707000070070000
00700700700700007070000070070000700700007000000070000000700700007007000070000000000700007007000070000000707070007707000070070000
00077000700700007770000070000000700700007770000077700000700000007777000070000000000700007770000070000000700070007077000070070000
00077000700700007007000070000000700700007000000070000000707700007007000070000000000700007007000070000000700070007077000070070000
00700700777700007007000070070000700700007000000070000000700700007007000070000000000700007007000070000000700070007007000070070000
00000000700700007007000070070000700700007000000070000000700700007007000070000000700700007007000070000000700070007007000070070000
00000000700700007770000007700000777000007777000070000000077000007007000070000000077000007007000077770000700070007007000007700000
77700000077000007770000007700000777000007007000070007000700070007000700070007000777700000000000070000000000000000007000000000000
70070000700700007007000070070000070000007007000070007000700070000707000070007000000700000000000070000000000000000007000000000000
70070000700700007007000070000000070000007007000070007000700070000707000070007000007000000770000077700000077000000777000007700000
77700000700700007770000007700000070000007007000070007000700070000070000007070000007000007007000070070000700700007007000070070000
70000000700700007007000000070000070000007007000007070000700070000070000000700000070000007007000070070000700000007007000077770000
70000000707700007007000000070000070000007007000007070000707070000707000000700000070000007007000070070000700000007007000070000000
70000000700700007007000070070000070000007007000007070000707070000707000000700000700000007007000070070000700700007007000070070000
70000000077070007007000007700000070000000770000000700000070700007000700000700000777700000770700007700000077000000770000007700000
00700000000000007000000070000000007000007000000070000000000000000000000000000000000000000000000000000000000000000700000000000000
07070000077000007000000000000000000000007000000070000000000000000000000000000000000000000000000000000000000000000700000000000000
07000000700700007770000070000000007000007007000070000000070700007070000007700000077000000770000070700000077000007770000070070000
77700000700700007007000070000000007000007007000070000000707070007707000070070000700700007007000077070000700700000700000070070000
07000000077700007007000070000000007000007770000070000000707070007007000070070000700700007007000070070000070000000700000070070000
07000000000700007007000070000000007000007007000070000000700070007007000070070000777000000777000070000000007000000700000070070000
07000000700700007007000070000000707000007007000070000000700070007007000070070000700000000007000070000000700700000700000070070000
07000000077000007007000070000000070000007007000007000000700070007007000007700000700000000007000070000000077000000700000007700000
00000000000000000000000000000000000000000770000007000000077000000770000070700000777700000770000077770000077000000770000070000000
00000000000000000000000000000000000000007007000077000000700700007007000070700000700000007007000000070000700700007007000070000000
70007000700070007000700070070000777700007007000007000000000700000007000070700000700000007000000000070000700700007007000070000000
70007000700070000707000070070000000700007077000007000000000700000070000077770000777000007770000000700000077000000777000070000000
07070000707070000070000070070000007000007707000007000000007000000007000000700000000700007007000007000000700700000007000070000000
07070000707070000070000007770000070000007007000007000000070000000007000000700000000700007007000070000000700700000007000070000000
00700000707070000707000000070000700000007007000007000000700000007007000000700000700700007007000070000000700700000007000000000000
00700000070700007000700077700000777700000770000077700000777700000770000000700000077000000770000070000000077000000007000070000000
07770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700000700000007070700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
