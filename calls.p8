pico-8 cartridge // http://www.pico-8.com
version 22
__lua__
cl=32

function lerp(a,b,t)
 return a+(b-a)*t
end

function gen_call(i)
 local base=0x3200+(68*i)
 
 cl=rnd(16)+8
 for i=0,63,1 do
  poke(base+i,0)
 end
   
 local old=rnd(8)+56
 for i=0,cl,4 do
  local new=rnd(8)+56
  for j=0,3 do
   local addr=base+(i+j)*2
   local pitch=lerp(old,new,j/4)
   poke2(addr, 0x0a00|pitch)
  end
  old=new
 end
end

song={}
function gen_song()
 local notes=ceil(rnd(4))
 for i=0,notes-1 do
  gen_call(i)
 end
 
 song={}
 local sl=ceil(rnd(3))
 for i=1,sl do
  add(song, flr(rnd(notes)))
 end
 
 note_delay=rnd(3)+2
 song_delay=rnd(15)+15
end

playing=false
note_idx=1
delay=0

function _update()
 if btnp(üÖæÔ∏è) then
  playing=not playing
 end
 if playing then
  if stat(20)==-1 then
   -- no note, where are we?   
   delay-=1
   if delay<0 then
    if note_idx<#song then
     note_idx+=1
     sfx(song[note_idx])
     
     -- when the note is done
     -- wait this amount of time
     delay=note_delay
     pd=delay
    else
     gen_song()
     note_idx=0
     
     -- generate the song.
     -- nothing is playing so 
     -- we'll wait this long 
     -- before playing. you'd expect
     -- it to be a trailing gap not
     -- a leading gap but :shrug:.
     delay=song_delay
     pd=delay
    end
   end
  end
 end
end

function _draw()
 cls(0)
 print(flr(pd).." "..stat(16).." "..stat(20))
	local s=stat(16)
	if s>=0 then
	 local base=0x3200+(68*s)
  for i=0,32 do
   local pitch=peek(base+(i*2))
   local x=(i*3)+2
   local c=14
   if i==stat(20) then
    c=7
   end
   line(x,96,x,96-pitch,c)
  end
 end
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100003305034050350503405032050300502c05028050230501d0501905016050140501305012050120501305014050180501e050250502b050300503305034050320502f0502805022050210502305024050
000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000100001e00000000370503c0503c00000000000000000000000380503c05000000000003805035050380503505038050350500000000000000003800013000380503c050000000000000000000000000000000
000900003c050000003c05000000000000000000000000003c0503205032000320003205000000000000000032050000000000000000000000000000000000000000000000000000000000000000000000000000
00080000300503c0500000000000000003005030050300503c0502c0003c00030000230003c000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00100720070500a0500c0500f050110501605016050180501b0501b0501d050160501605016050180501b0501f0501f05022050220502705029050270502705027050220501f0502205022050220502405027050
